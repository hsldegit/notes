# JVM常见知识点
<!-- TOC -->
[toc]
<!-- /TOC -->

## G1精讲

G1的思路说起来也类似，它不要求每次都把垃圾清理的干干净净，它只是努力做它认为对的事情。我们要求G1，在任意1秒的时间内，停顿不得超过10ms，这就是在给它制定KPI。G1会尽量达成这个目标，它能够推算出本次要收集的大体区域，以增量的方式完成收集。
这也是使用 G1 垃圾回收器不得不设置的一个参数：
-XX:MaxGCPauseMillis=10
G1 的全称是 Garbage­First GC，为了达成上面制定的 KPI，它和前面介绍的垃圾回收器，在对堆的划分上有一些不同。

其他的回收器，都是对某个年代的整体收集，收集时间上自然不好控制。G1 把堆切成了很多份，把每一份当作一个小目标，部分上目标很容易达成。
G1 也是有 Eden 区和 Survivor 区的概念的，只不过它们在内存上不是连续的，而是由一小份一小份组成的。
这一小份区域的大小是固定的，名字叫作小堆区（Region）。小堆区可以是 Eden 区，也可以是 Survivor 区，还可以是 Old 区。所以 G1 的年轻代和老年代的概念都是逻辑上的。
每一块 Region，大小都是一致的，它的数值是在 1M 到 32M 字节之间的一个 2 的幂值数。
但假如我的对象太大，一个 Region 放不下了怎么办？注意图中有一块面积很大的黄色区域，它的名字叫作 Humongous Region，大小超过 Region 50% 的对象，将会在这里分配。
垃圾最多的小堆区，会被优先收集。这就是 G1 名字的由来。

RSet
它的全称是 Remembered Set，用于记录和维护 Region 之间的对象引用关系。
但RSet与CardTable有些不同的地方。CardTable是一种points-out（我引用了谁的对象）的结构。而RSet记录了其他Region中的对象引用本 Region 中对象的关系，属于 points-into 结构（谁引用了我的对象），有点倒排索引的味道。
你可以把 RSet 理解成一个 Hash，key 是引用的 Region 地址，value 是引用它的对象的卡页集合

### ZGC

如果应用的内存非常吃紧，对内存进行部分回收根本不够，始终要进行整个 Heap 的回收，那么 G1 要做的工作量就一点也不会比其他垃圾回收器少，而且因为本身算法复杂了，还可能比其他回收器要差。
所以垃圾回收器本身的优化和升级，从来都没有停止过。

最新的 ZGC 垃圾回收器，就有 3 个令人振奋的 Flag：

- 停顿时间不会超过 10ms；
- 停顿时间不会随着堆的增大而增大（不管多大的堆都能保持在 10ms 以下）；
- 可支持几百 M，甚至几 T 的堆大小（最大支持 4T）。

### 问题排查命令

top 找到使用CPU最多的进程 记录pid shif+p可以排序

再次使用 top -Hp $pid 记录线程id

使用 printf 将十进制tid转换成十六进制 printf %x $tid

使用 jstack 命令，查看 Java 进程的线程栈。 jstack $pid >$pid.log

使用 less 命令查看生成的文件，并查找刚才转化的十六进制 tid，找到发生问题的线程上下文。 less $pid.log

jmap 可以查看堆内存

jstack 查看 Java 进程的线程栈

jinfo 进程快照，最后的遗言

dmesg 进程挂掉的最后线索

jstat 将输出当前的 gc 信息。一般，基本能大体看出一个端倪，如果不能，可将借助 jmap 来进行分析。

### 现场保留

有两种方式来获取内存的快照

我们前面提到过，通过配置一些参数，可以在发生 OOM 的时候，被动 dump 一份堆栈信息(HeapDumpOnOutOfMemoryError)

通过 jmap 主动去获取内存的快照。(jmap -dump:format=b,file=heap.bin 37340)

使用MAT解析dump文件 查看信息

### 堆外内存排查(java 8 元空间 或者直接内存)

实际内存使用超出了最大内存设定的一倍还多，这明显是不正常的，肯定是使用了堆外内存。

Metaspace属于堆外内存，但由于它是单独管理的，所以排查起来没什么难度。你平常可能见到的使用堆外内存的场景还有下面这些：

JNI或者JNA程序，直接操纵了本地内存，比如一些加密库；

使用了Java 的 Unsafe 类，做了一些本地内存的操作

Netty 的直接内存（Direct Memory），底层会调用操作系统的 malloc 函数。

堆外内存排查 dump不要dump太多 一次64mb最好  使用 perf或者gperftools





